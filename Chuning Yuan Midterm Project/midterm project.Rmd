---
title: "Midterm Project"
author: "Chuning Yuan"
date: "2019/12/5"
output: pdf_document
---

# I.Introduction 

Nowadays, Airbnb has become very popular for the traveler’s due to its unique style and creative design and competitive prices and location than the hotels. Therefore, I think it will be interesting to explore the data set of Airbnb, we can look at how are the price for a night stay for each room were affected by other variables such as reviews, number of bedrooms, minimum stays etc. This project will contain analysis on Airbnb data with EDA (Exploratory Data Analysis) and modeling. From this project, we will be able to have a general idea how to predict the price of rooms on Airbnb website and what’s the most influential factor in predicting process.


According to the officially website Airbnb is a privately held global company, the headquarter is located in San Francisco, it operates an online marketplace and hospitality service can be accessible through websites and mobile apps. People can use the service to arrange or provide lodging, homestays, or tourism experiences. I choose the data of San Francisco is also because it is where Airbnb has grown around the world from, and I have the experience of searching Airbnb in bay area. First, I will read in the data and do some visualization to see which predictor will contributes more to the prediction of price. And then the modeling will be multi-level regression using room type and neighborhood and few other factors to predict the price.


```{r setup, include=FALSE,echo=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(ggplot2,tidyverse,stringr,kableExtra,dplyr,sqldf,ggpubr,coefplot,lme4,arm)
```

```{r echo=FALSE,include=FALSE,warning=FALSE}
files = list.files(pattern = ".csv")
files = files[which(str_detect(files,pattern = "2017"))]
c = setNames(files,paste0("sanf",1:length(files)))
list2env(lapply(c,read.csv),envir = .GlobalEnv)
v.l = intersect(names(sanf5),names(sanf6))
for(i in 1:length(files)){
  assign(x = paste0("sanf", i),value = dplyr::select(get(paste0("sanf", i)),v.l))
}
sanf = sanf1
for(i in 2:length(files)){
  sanf = rbind(sanf,get(paste0("sanf", i)))
}
```

# II. Data 

## Data source

The data set was extracted from the tomslee.net website: Airbnb Data Collection, under the section get the data. There is zip file for many cities around the world. The zip file holds one or more csv files. Each csv file represents a single “survey” or “scrape” of the Airbnb web site for that city. To be specific, the data used for this project was collected from the November 2013 to January 2017 in San Francisco. There are 9 variables that will be used in this project. They are room id, host id, room type, neighborhood, number of reviews, overall satisfaction, number of accommodates, number of bedrooms and price. We are assuming the potential factors to influence the pricing are the room type, neighborhood, number of reviews, overall satisfaction, number of accommodates and number of bedrooms.
 
## Data Cleaning 


## Overview of data


### Table 1. Summary of the data:

```{r warning=FALSE}
summary(sanf)
# filter observations with more than 100 reviews 
sanf.re = sanf %>% filter(reviews > 100)
# count the observations in each neighborhood
count.nerbor = sanf.re %>% count(neighborhood) %>% arrange(desc(n))
# extract neighborhood with more than 30 observations
count.nerbor = count.nerbor %>% filter(n>30)
sanf.re = sanf.re[which(sanf.re$neighborhood %in% count.nerbor$neighborhood),]
# export dataset to CSV file
write.csv(sanf.re,"san_francisco_data_final.csv")
data = read.csv("san_francisco_data_final.csv")
Airbnb = data[,c(2:12)]
#eliminate all the NA value.
SFAirbnb = subset(Airbnb, select = -c(borough,minstay))
```

Because the dataset is very large, we want to extract the information as more useful and informative as possible, so we filter the observation with more than 100 reviews because these could be more representative in general, and extract neighborhood with more than 30 observations for the further modeling analysis. Below is the data overview after the cleaning processes.According to the summary we can delete the the column borough and minstay because there is no value in them. After eliminate all the NA, now we have the cleaned data we need, then we can start our EDA process.


### Table 2. The head of the data:

```{r echo=FALSE}
kable(head(data[,c(2:4,6:8,11)]))
```

# III. EDA 

```{r echo=FALSE,warning=FALSE}
#create a histgram of the distribution of price from 30 to 300, since this range will be the majority of price fall in.
ggplot(SFAirbnb, aes(price))+ geom_histogram(binwidth = 5, color = "black", fill = "pink")+ 
ggtitle("Figure 1. Distribution of room price") + 
ylab ("frequency of price") + xlab("Price") + xlim(30,300)

#since the response varible, price is not normal distributed, we are going to do log transformation on this variable.
df <- SFAirbnb %>% mutate(logprice = log(price))
#The distribution plot of transformed price  
ggplot(df, aes(log(price)))+ geom_histogram(binwidth = 0.2, color = "black", fill = "pink")+ ggtitle("Figure 2.Distribution of room price") + ylab ("frequency of transformedprice") + xlab("log(Price)")+ xlim(3,7)
```



## What is the price range for SF Airbnb, what would be a common price we should expect when we are searching the Airbnb in SF?

*We take a look at the room price distribution, and it is obvious that the most popular price are around 100, and between 100-150.*


```{r echo=FALSE,warning=FALSE}
ggplot(SFAirbnb, aes(reviews))+ geom_histogram(binwidth = 5,color = "black", fill = "pink")+ ggtitle("Figure 3.distribution of number of reviews") + ylab ("frequency of reviews") + xlab("number of reviews")+ xlim(100,250)
```



## How many reivew would be a common amount we should expect when we are searching the Airbnb in SF?

*Since we have already filter the reviews that is less than 100, here the distribution plot can tell us that most of the reviews are around 100 to 175,most of the reivews are ubder 200. This provide us some general ideas of number of reivews for the San Francisco Airbnb, so we can know how much reviews to expect when we are choosing the Airbnb from the website based on the reivews.*


```{r echo=FALSE}
ggplot(SFAirbnb, aes(overall_satisfaction))+ geom_histogram(binwidth = 0.25, color = "black", fill = "pink")+ ggtitle("Figure 4.distribution of overall satisfaction") + ylab ("frequency of overall satisfaction") + xlab("overall_satisfaction")
```



## How are the Airbnb rated in SF Airbnb, is there any extreme good or bad rating we should be aware of?

*In this histgram plot, most of overall rating is aroud 4.5 and 5. There are also a small portion of people rate the room 3.9  to 4 star. Overall, customers are satisfied with most of rooms in San Francisco area.*



```{r echo=FALSE,warning=FALSE}
Rating<-sqldf("SELECT overall_satisfaction, COUNT (room_id) FROM SFAirbnb Group by 1")
colnames(Rating)<-c("rating","Num_room")
#create a new dataset called neighborhood.
neighborhood<-sqldf("SELECT neighborhood, COUNT (room_id), Avg(overall_satisfaction),avg(price),avg(reviews) FROM SFAirbnb Group by 1")
#rename the column of the dataset.
colnames(neighborhood)<-c("neighborhood","Num_room", "Avg_rating","Avg_price", "reviews")


a=ggplot(data=neighborhood, aes(x=reorder(neighborhood,-reviews), y= reviews))+geom_bar(stat = "identity",  fill = "coral") + ggtitle("Figure 5.Average number of reviews per neighborhood")+ylab("Average # of reviews") + theme(axis.text.x = element_text(angle = 75, hjust = 1))+theme(plot.title = element_text(size = (9)))

b=ggplot(data=neighborhood, aes(x=reorder(neighborhood,-Avg_rating), y= Avg_rating))+geom_bar(stat = "identity", fill = "coral") + ggtitle("Figure 6.Average rating of airbnb rooms per neighborhood")+ylab("Average rating of room") + theme(axis.text.x = element_text(angle = 75, hjust = 1))+theme(plot.title = element_text(size = (9)))

ggarrange(a,b,ncol=2,nrow=1)

ggplot(data=neighborhood, aes(x=reorder(neighborhood,-Avg_price), y= Avg_price))+geom_bar(stat = "identity",  fill = "coral") + ggtitle("Figure 7.Average price per neighborhood")+ylab("Average price") + theme(axis.text.x = element_text(angle = 45, hjust = 1))



```



## How are the number of reviews, price and rating different in each neighborhood?

*From this plot, the Potrero Hill area has the highest number of review (over 200), while Excelsior has the lowest average number of reviews beside those less than 100 reviews. We can observe that the average number of review do vary a lot by neighborhood. Although there is not much  differnce of rating among different neighborhood, still the neighborhood of the Airbnb room could be an influence predictor based on figure 6. We need to include this predictor in the model to see whether rating is a significant for predicting price of rooms.*


```{r echo=FALSE}
room_type <- sqldf("SELECT room_type, count(room_id), Avg(overall_satisfaction), avg(price) FROM SFAirbnb Group by 1")
colnames(room_type) = c("room_type","Num_room", "Avg_rating","Avg_price")
ggplot(data = room_type, aes(x= reorder(room_type,-Avg_price),y = Avg_price,fill = room_type)) + geom_bar(stat = "identity", ) + ggtitle("Figure 8.Average price for different room types") + ylab("Average_price")+ xlab("Room_type") 
```

## What the Average price for different room types:


*This result is consistent with our common sense and meaning the pricing of Airbnb in San Francisco are reasonable as the bigger the room type has the higher average price.*

## Testing other predictors


```{r echo=FALSE}
res <- cor.test(SFAirbnb$accommodates, SFAirbnb$bedrooms, 
                    method = "pearson")
res
```

*Considering the bedrooms and the accommodates could be two correlated predictors, because the number of bedroom set up the maximum number of customers that can be stay in. So we use a correlation test for the next step. The p-value of this test is 2.2e-16. Reject the null hypothesis. So correlation between the those two variables is significant. Therefore we can add the correlation term into the model to test whether this influence term is significant.*

# IV. Modelling: 

## Model1: Simple linear regression: 

$$log(price) =  \alpha + \beta_1 x_{room type} +\beta_2 x_{reviews} + \beta_3x_{rating} +\beta_4x_{accommodates*bedrooms} + \beta_5 x_{accommodates}+\beta_6 x_{bedrooms} $$
```{r echo=FALSE}
#model1 simple linear regression:
model1 = lm(logprice~ room_type + reviews + overall_satisfaction + accommodates+ accommodates*bedrooms, data = df) 
summary(model1)
plot(model1,which =c(1,2))#create a residual plot and Q-Q plot.

```

*From this simple linear regression,from the results we can see most of the predictoirs are significant. The preditcor bedrooms is not significant to price, we may want to eliminate those predictors in the multilevel models. The R-square in the model is 0.6137 which means the model dose not fit very good. However, in the residual plot, there are some points have big residual: 1674,3252. Those might be some extrem values of prices that lead to big residuals.The rest of points are symmetrically distributed around the line h = 0. In the QQ plot, we can see in the middle most dots falls on the line. However, the data have more extreme values on the tail of the distribution. Next step we expand simple linear model to multilevel linear model.*

## Model2: Multilevel linear model with random intercept: 

$$log(price) =  \alpha_{i} + \beta_1 x_{roomtype} +\beta_2 x_{reviews}+\beta_3 x_{overall satisfaction}  +\beta_4x_{accommodates*bedrooms} + \beta_5 x_{accommodates}$$
```{r echo=FALSE,include=FALSE}
model2 = lmer(log(price) ~ room_type +reviews+ overall_satisfaction + accommodates  +accommodates*bedrooms+ (1|neighborhood)-1, data = df)
summary(model2)
confint(model2)
```



## Model3 :  Multilevel linear model with random slope:

$$log(price) =  \alpha_{i} + \beta_1 x_{roomtype} ++\beta_{2[i]} x_{overall satisfaction}  +\beta_3x_{accommodates*bedrooms} + \beta_4 x_{accommodates}$$
```{r echo=FALSE, include=FALSE}
model3 = lmer(logprice ~ room_type + overall_satisfaction + accommodates +accommodates*bedrooms + (0+ overall_satisfaction|neighborhood)-1, data = df)
summary(model3)
confint(model3)
```


## Model4 :  Multilevel linear model with random slope and random intercept:

$$log(price) =  \alpha_{i}+\beta_1 x_{roomtype} +\beta_{2[i]} x_{overall satisfaction}  +\beta_3x_{accommodates*bedrooms} + \beta_4 x_{accommodates} $$

```{r echo=FALSE, warning=FALSE}
model4 = lmer(logprice ~ room_type+ overall_satisfaction + accommodates +accommodates*bedrooms + (1 + overall_satisfaction|neighborhood)-1, data = df)
summary(model4)
confint(model4)
```

*This is the model is based on model2 and model3 with random slope as well random intercept. According to the output from this model, we can interpret coeiffients as the average log.price of entire home/apt is 2.95, the confidence interval did not cross zero which mean the predictors is significant to our result. And for the coefficent of the overall satisfaction can be understand as for each Airbnb the rating of increase by 1, the log price of this Airbnb will increase 0.36, although the range of the rating is not very big according the previous plot(figure.6), we still consider this predictors significant snice it also contain the confidence interval that not cross zero* 

# V. Result: 

*Since we have 3 multilevel models with similar structures, we want to run ANOVA test to test whether there's any difference among the models and which model has best goodness of fit.*

```{r echo=FALSE}
anova(model2, model3, model4, refit = FALSE)
plot(fitted(model4),resid(model4,type="pearson"),col="pink", main = "Figure 9. residual plot for model4")
abline(h =0)
coef = coef(model4)$"neighborhood"
#coef
max(coef$`(Intercept)`)

```

*According to the output of the test, we can see that model 4 with random intercept and random slope is the best fit among three multilevel models. It has lowest deviance with 583.33. The second plot is a residual plot form model 4. As we can see the plot the points are symmetrically distributed around the line h = 0. The neighborhood with the maximum intercept is Parkside with intercept 2.816. From the analysis above we found the best model among is the Model4. From the model,we can found that the most significant predictor is the factor of room type. The second significant predictors is the district of neighborhood. Also, higher overall satisfaction will lead to a higher price. The ideas of building these model is to predicting models by different levels of neighborhood. The model in each level will have a unique intercept and a unique slope for the predictor overall satisfaction, in this way it will lead the last model minimize the deviance comparing to the previous two multilevel linear model.*


# VI. Discussion: 

The result terms out to be not very surprirsing, although I though the reviews would so how affect the price of Airbnb in San Francisco. The reality here is that the factor of room type will be determine the price the most, which is reasonable because from what my knowledge, San Francisco is one of the most expensive living environment in the U.S. especially the bay area has the highest housing price. Therefore it is a place the every inch is like the price as gold. The room type of Airbnb is more like the different room size for the hotel. The entire home/apt tends to serve more people and have bigger space at one time. So the price of entire home/apt should be higher than the other two room type. Also, the second term neighborhood is obvious to be significant. This is because based on the living environment in San Francisco there are many tech company and university in the city, as well as the neighborhood around union square, twin peak is close to downtown area and there are many sight-seeing spots for tourists. We can conclude that our findings are reasonable. 

However, this analysis is definitely not perfect. There are only 4 predictors in the multilevel model. Those predictors are the most significant variables we found in the dataset. This is just a very basic analysis of the Airbnb data, there are many other factors that can take in to account, such as the academic institution in the neighborhood or the transportation condition, and also the geographic difference in countries will be interesting to explore in the future. That wil be the future direction of this project.


# VII.Reference 

http://tomslee.net

https://en.wikipedia.org/wiki/Airbnb

https://www.airbnb.com/

# VIII. Appendix 

## Output and residual plot for model 2

```{r echo=FALSE}
model2 = lmer(log(price) ~ room_type +reviews+ overall_satisfaction + accommodates  +accommodates*bedrooms+ (1|neighborhood)-1, data = df)
summary(model2)
confint(model2)
plot(fitted(model2),resid(model2,type="pearson"),col="pink", main = "residual plot for model2")
abline(h =0)
```

*In our second model, we gets rid of non-significant terms bedrooms.The factor of room type plays the most important part in the model. The coefficent of reviews is zero so we don't need to keep it for the next model. Besides, the overall satisfaction is the second influential term in this model other than the room type.*

## Output and residual plot for model 3

```{r echo=FALSE}
model3 = lmer(logprice ~ room_type + overall_satisfaction + accommodates +accommodates*bedrooms + (0+ overall_satisfaction|neighborhood)-1, data = df)
summary(model3)
confint(model3)

plot(fitted(model3),resid(model3,type="pearson"),col="pink", main = "residual plot for model3")
abline(h =0)
```



